name: Build and Release

on:
  workflow_dispatch:
  release:
    types:
      - published

permissions:
  contents: write
  packages: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: false

      # - name: Resolve Go cache paths
      #   id: go-cache
      #   run: |
      #     echo "mod=$(go env GOMODCACHE)" >> "$GITHUB_OUTPUT"
      #     echo "build=$(go env GOCACHE)" >> "$GITHUB_OUTPUT"

      # - name: Cache Go modules and build cache
      #   uses: runs-on/cache@v4
      #   with:
      #     path: |
      #       ${{ steps.go-cache.outputs.mod }}
      #       ${{ steps.go-cache.outputs.build }}
      #     key: go-${{ hashFiles('go.sum') }}
      #     restore-keys: |
      #       go-
      #   env:
      #     RUNS_ON_S3_BUCKET_CACHE: github-actions-cache
      #     RUNS_ON_S3_BUCKET_ENDPOINT: ${{ secrets.AWS_ENDPOINT_URL }}
      #     AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #     AWS_REGION: "auto"
      
      - name: Set up ko
        uses: ko-build/setup-ko@v0.9

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # - name: Update Helm chart appVersion
      #   if: github.event_name == 'release'
      #   run: |
      #     VERSION="${GITHUB_REF_NAME#v}"
      #     git config user.name "github-actions[bot]"
      #     git config user.email "github-actions[bot]@users.noreply.github.com"
      #     git fetch origin main
      #     git checkout main
      #     sed -i "s/^appVersion:.*/appVersion: \"${VERSION}\"/" charts/image-updater/Chart.yaml
      #     git add charts/image-updater/Chart.yaml
      #     git diff --cached --quiet || (git commit -m "chore: update Helm chart appVersion to ${VERSION}" && git push)